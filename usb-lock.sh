#!/bin/sh

# Файл: usb-lock.sh
# Описание: Скрипт для блокировки загрузки системы Linux без наличия определенного USB-устройства.
#            Предназначен для использования в initramfs на этапе init-bottom.

# REQUIRED_SERIAL: Укажите здесь серийный номер вашего USB-накопителя, который будет использоваться для аутентификации.
#                  Его можно получить с помощью команды `lsusb -v -d <VendorID>:<ProductID> | grep iSerial`.
#                  ВНИМАНИЕ: Никогда не храните реальные серийные номера в публичных репозиториях!
#                  Используйте плейсхолдер и вводите реальное значение через скрипт установки или вручную.
SERIAL_NUMBER="YOUR_SERIAL_NUMBER"

# Функция check_usb_device()
# Описание: Проверяет наличие подключенного USB-устройства с заданным серийным номером.
# Возвращает: 0, если устройство найдено; 1, если не найдено.
check_usb_device() {
    # Перебираем все подключенные USB-устройства в /sys/bus/usb/devices/
    for dev in /sys/bus/usb/devices/*; do
        # Проверяем, существует ли файл 'serial' для текущего устройства (не у всех устройств есть).
        if [ -e "$dev/serial" ]; then
            # Читаем серийный номер из файла.
            SERIAL=$(cat "$dev/serial")
            # Сравниваем прочитанный серийный номер с требуемым.
            if [ "$SERIAL" = "$SERIAL_NUMBER" ]; then
                return 0 # Устройство найдено
            fi
        fi
    done
    return 1 # Устройство не найдено
}

# Функция main()
# Описание: Основная логика скрипта. Выполняет проверку USB, управляет таймером и действием при истечении таймера.
main() {
    echo "Проверка наличия USB-устройства с серийным номером $SERIAL_NUMBER..." > /dev/console
    # Если устройство найдено сразу, продолжаем загрузку.
    if check_usb_device; then
        echo "Устройство найдено. Продолжаем загрузку." > /dev/console
        return 0
    fi

    echo "Устройство не найдено. Ожидание подключения..." > /dev/console
    # Запускаем 30-секундный таймер ожидания.
    for i in $(seq 30 -1 1); do
        echo "Осталось $i секунд..." > /dev/console
        sleep 1 # Ждем 1 секунду
        # Проверяем наличие устройства на каждой итерации таймера.
        if check_usb_device; then
            echo "Устройство подключено. Продолжаем загрузку." > /dev/console
            return 0 # Устройство подключено, продолжаем загрузку
        fi
    done

    # Если таймер истек и устройство не было подключено, выключаем систему.
    echo "Таймер истек. Выключение системы." > /dev/console
    poweroff
}

# Запуск основной функции
main
